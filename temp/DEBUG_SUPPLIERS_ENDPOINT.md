# Debug Log: /moderator/suppliers Endpoint Issue

**⚠️ ВАЖНО: Все решения задокументированы в `docs/TROUBLESHOOTING.md` (Библия ошибок). Этот файл является историческим логом отладки.**

## ✅ РЕШЕНО: Проблема была в нескольких процессах на порту 8000

**Дата решения:** 2025-12-26
**Причина:** На порту 8000 слушали несколько процессов Backend, и запрос шел не к тому процессу, который был обновлен.

**Решение:**
1. Остановлены все процессы на порту 8000
2. Запущен только один процесс Backend
3. Endpoint начал работать корректно

**Результат:** Endpoint возвращает 200 OK с правильными CORS заголовками.

---

# Диагностика ошибки 500 на `/moderator/suppliers`

## Проблема
- Endpoint `/moderator/suppliers` возвращает 500 Internal Server Error
- CORS заголовки отсутствуют в ответе
- **Логи НЕ появляются в терминале Backend (ни middleware, ни endpoint не вызываются)**
- Ошибка происходит ДО того, как запрос доходит до FastAPI
- Другие endpoints (`/health`, `/`) работают нормально

## Попытки решения

### ✅ Попытка 1: Добавление CORS middleware и обработчиков ошибок
**Файлы:** `backend/app/main.py`
**Что сделано:**
- Добавлен `CORSExceptionMiddleware` для обработки ошибок с CORS заголовками
- Добавлены глобальные обработчики исключений (`FastAPIHTTPException`, `Exception`, `RequestValidationError`)
- Обработчики регистрируются ДО включения роутеров

**Результат:** ❌ Не сработало - ошибка все еще происходит, логи не появляются

### ✅ Попытка 2: Упрощение endpoint без dependency `get_db`
**Файлы:** `backend/app/transport/routers/moderator_suppliers.py`
**Что сделано:**
- Убрал dependency `db: AsyncSession = Depends(get_db)` из endpoint
- Упростил ответ до простого dict без запросов к БД
- Добавил `print()` для логирования

**Результат:** ❌ Не сработало - ошибка все еще происходит, логи не появляются

### ✅ Попытка 3: Добавление логирования в stderr
**Файлы:** `backend/app/main.py`, `backend/app/transport/routers/moderator_suppliers.py`
**Что сделано:**
- Добавил `print(..., file=sys.stderr, flush=True)` в middleware и endpoint
- Настроил логирование через `logging.basicConfig` с уровнем DEBUG

**Результат:** ❌ Не сработало - логи все еще не появляются

### ✅ Попытка 4: Перемещение обработчиков ошибок ДО роутеров
**Файлы:** `backend/app/main.py`
**Что сделано:**
- Переместил регистрацию обработчиков ошибок ДО `app.include_router()`
- Убедился, что обработчики регистрируются в правильном порядке

**Результат:** ❌ Не сработало - ошибка все еще происходит, логи не появляются

### ✅ Попытка 5: Упрощение endpoint до абсолютного минимума
**Файлы:** `backend/app/transport/routers/moderator_suppliers.py`
**Что сделано:**
- Убрал все параметры из endpoint
- Убрал все dependencies
- Вернул простой dict без Pydantic

**Результат:** ❌ Не сработало - ошибка все еще происходит, логи не появляются

### ✅ Попытка 6: Добавление обработчика ошибок на уровне Starlette
**Файлы:** `backend/app/main.py`
**Гипотеза:** Ошибка происходит на уровне Starlette ДО того, как запрос доходит до FastAPI middleware
**Что сделано:**
- Добавил обработчик ошибок на уровне Starlette через `app.add_exception_handler(Exception, ...)`
- Обработчик логирует ошибки в stderr и добавляет CORS заголовки

**Результат:** ❌ Логи не появляются - ошибка происходит ДО Starlette

### ✅ Попытка 7: Добавление try-except в endpoint
**Файлы:** `backend/app/transport/routers/moderator_suppliers.py`
**Гипотеза:** Ошибка может происходить внутри endpoint при обработке параметров
**Что сделано:**
- Добавил try-except блок в endpoint для перехвата любых исключений
- Добавил логирование исключений в stderr

**Результат:** ❌ Логи не появляются - ошибка происходит ДО endpoint

### ✅ Попытка 8: Создание нового endpoint с другим путем
**Файлы:** `backend/app/transport/routers/moderator_suppliers.py`
**Гипотеза:** Проблема может быть специфична для пути `/suppliers` (возможно, конфликт маршрутов)
**Что сделано:**
- Создал новый endpoint `/suppliers-new` с тем же кодом
- Проверил, что маршрут регистрируется в приложении

**Результат:** ❌ Не сработало - ошибка все еще происходит

### ✅ Попытка 9: Проверка нескольких процессов на порту 8000
**Гипотеза:** На порту 8000 слушают несколько процессов, и запрос идет не к тому процессу
**Что сделано:**
- Проверил процессы на порту 8000 через `netstat -ano`
- Обнаружено несколько процессов на порту 8000
- Остановлены все процессы и запущен только один

**Результат:** ✅ РЕШЕНО - Endpoint начал работать корректно!

## Выводы

1. **Проблема была в нескольких процессах на порту 8000** - запрос шел не к тому процессу, который был обновлен
2. **Решение:** Остановить все процессы и запустить только один процесс Backend
3. **Endpoint теперь работает корректно** - возвращает 200 OK с правильными CORS заголовками

## Отвергнутые гипотезы

- ❌ Проблема в CORS middleware
- ❌ Проблема в обработчиках ошибок
- ❌ Проблема в endpoint коде
- ❌ Проблема в параметрах endpoint
- ❌ Проблема в dependencies
- ❌ Проблема в маршрутизации FastAPI
- ❌ Проблема в Starlette exception handling
