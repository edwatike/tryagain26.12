# Шаблон для документирования ошибки в TROUBLESHOOTING.md

Скопируйте этот шаблон в `docs/TROUBLESHOOTING.md` и заполните все поля.

```markdown
## Ошибка N: [Краткое название ошибки]

### Описание проблемы
[Что происходит, какие ошибки видны, где возникает]

**Симптомы:**
- [Симптом 1]
- [Симптом 2]
- [Симптом 3]

**Где возникает:**
- [Место возникновения: страница, endpoint, функция и т.д.]

**Когда возникает:**
- [Условия возникновения: при выполнении определенного действия, при определенных данных и т.д.]

### Причина
[Почему это происходит, что вызывает проблему]

**Корневая причина:**
- [Основная причина]

**Сопутствующие факторы:**
- [Фактор 1]
- [Фактор 2]

### Решение
[Пошаговое решение с кодом и командами]

**Шаг 1: [Название шага]**
```python
# Код изменений
```

**Шаг 2: [Название шага]**
```typescript
// Код изменений
```

**Команды для применения:**
```powershell
# Команда 1
# Команда 2
```

### Проверка
[Команды для проверки и ожидаемый результат]

**Проверка через API:**
```powershell
# Команда для проверки
# Ожидаемый результат
```

**Проверка через Frontend:**
1. Открыть страницу [URL]
2. Выполнить действие [описание]
3. Убедиться, что [ожидаемый результат]

**Ожидаемый результат:**
- [Результат 1]
- [Результат 2]

### Измененные файлы
- `path/to/file1.py` - [описание изменений]
- `path/to/file2.tsx` - [описание изменений]
- `path/to/file3.sql` - [описание изменений]

### Связанные ошибки
- [Ссылка на связанную ошибку, если есть]

### Дата решения
YYYY-MM-DD

### Автор решения
[Имя или AI-агент]

### Дополнительные заметки
[Любая дополнительная информация, которая может быть полезна]
```

## Пример заполненного шаблона

```markdown
## Ошибка: Домен не исчезает после добавления в blacklist

### Описание проблемы
После добавления домена в blacklist через фронтенд, домен продолжает отображаться в результатах парсинга.

**Симптомы:**
- Домен добавляется в blacklist (видно уведомление)
- Домен не исчезает из списка результатов
- Количество результатов не изменяется

**Где возникает:**
- Страница результатов парсинга: `/parsing-runs/[runId]`
- Endpoint: `POST /moderator/blacklist`

**Когда возникает:**
- При добавлении домена в blacklist через кнопку "Добавить в blacklist"
- После перезагрузки данных

### Причина
1. `log_audit` вызывался до `commit()`, что приводило к откату транзакции при ошибке audit log
2. Нормализация домена не совпадала между frontend и backend

**Корневая причина:**
- Неправильный порядок операций в endpoint (audit log до commit)

**Сопутствующие факторы:**
- Разная нормализация доменов на frontend и backend
- Отсутствие проверки через реальный фронтенд при разработке

### Решение
**Шаг 1: Изменить порядок операций в blacklist endpoint**
```python
# backend/app/transport/routers/blacklist.py
# Сначала commit, потом audit log в отдельной транзакции
await db.commit()
# Затем audit log
```

**Шаг 2: Добавить нормализацию root domain на backend**
```python
# backend/app/transport/schemas/blacklist.py
def extract_root_domain(domain: str) -> str:
    # Нормализация root domain
```

**Шаг 3: Нормализовать домен на frontend**
```typescript
// frontend/moderator-dashboard-ui/app/parsing-runs/[runId]/page.tsx
const normalizedDomain = extractRootDomain(domain)
```

**Команды для применения:**
```powershell
# Перезапустить Backend для применения изменений
# Проверить через фронтенд
```

### Проверка
**Проверка через API:**
```powershell
python temp/test_blacklist_api.py
# Ожидаемый результат: домен добавляется и сохраняется в БД
```

**Проверка через Frontend:**
1. Открыть страницу `/parsing-runs/[runId]`
2. Нажать "Добавить в blacklist" для любого домена
3. Убедиться, что домен исчез из списка результатов

**Ожидаемый результат:**
- Домен добавляется в blacklist
- Домен исчезает из списка результатов
- Количество результатов уменьшается

### Измененные файлы
- `backend/app/transport/routers/blacklist.py` - изменен порядок операций (commit перед audit log)
- `backend/app/transport/schemas/blacklist.py` - добавлена нормализация root domain
- `frontend/moderator-dashboard-ui/app/parsing-runs/[runId]/page.tsx` - нормализация домена перед отправкой

### Дата решения
2025-12-29

### Автор решения
AI-агент (Auto)

### Дополнительные заметки
Проблема была обнаружена только после проверки через реальный фронтенд. 
API тесты показывали, что все работает, но реальное поведение было другим.
Это подтверждает важность проверки гипотез через реальный фронтенд.
```











