# Рекомендации по повышению качества работы

Этот документ содержит рекомендации для улучшения процесса разработки, диагностики проблем и повышения качества кода.

## 1. Проверка гипотез через фронтенд

### Правило

**Все гипотезы о работе функциональности ОБЯЗАТЕЛЬНО проверяются через реальный фронтенд.**

### Почему это важно

- Одна команда через фронтенд может разобрать проблему быстрее, чем множество предположений
- Логика может выглядеть правильной, но не работать из-за проблем с состоянием React, кэшированием или другими факторами
- API тесты не показывают реальное поведение пользователя

### Примеры правильного и неправильного подхода

**❌ НЕПРАВИЛЬНО:**
```
"Логика фильтрации выглядит правильно, должно работать"
"Код компилируется без ошибок, значит все работает"
"API возвращает правильные данные, значит frontend должен работать"
```

**✅ ПРАВИЛЬНО:**
```
"Проверил через API - фильтрация работает. Теперь проверю через реальный фронтенд"
"Создал тестовый скрипт, который симулирует работу frontend - фильтрация работает. 
Теперь проверю через реальный фронтенд"
"Проверил через curl и симуляцию - все работает. Открыл страницу в браузере, 
выполнил операцию - подтвердил, что решение работает"
```

### Чеклист проверки гипотезы

1. ✅ Сформулировать гипотезу четко
2. ✅ Создать тест/скрипт для проверки (если нужно)
3. ✅ Проверить через API (если применимо)
4. ✅ **ОБЯЗАТЕЛЬНО проверить через реальный фронтенд** - открыть страницу, выполнить операцию
5. ✅ Только после подтверждения через фронтенд - заявлять, что решение работает

### Команды для быстрой проверки

```powershell
# Проверка доступности фронтенда
curl http://localhost:3000

# Проверка доступности бэкенда
curl http://127.0.0.1:8000/health

# Проверка через API (пример)
curl -X POST "http://127.0.0.1:8000/moderator/blacklist" -H "Content-Type: application/json" -d '{"domain":"test.ru"}'
```

## 2. Автоматизация проверок

### Скрипты для быстрой проверки функциональности

#### Готовые инструменты

В проекте уже созданы готовые инструменты для автоматизации:

1. **`scripts/quick-check.ps1`** - Быстрая проверка всех сервисов
   ```powershell
   .\scripts\quick-check.ps1 all        # Проверить все сервисы
   .\scripts\quick-check.ps1 backend    # Только Backend
   .\scripts\quick-check.ps1 frontend   # Только Frontend
   .\scripts\quick-check.ps1 parser     # Только Parser Service
   ```

2. **`scripts/pre-commit.ps1`** - Pre-commit hook для автоматических проверок
   - Установка: `.\scripts\setup-pre-commit.ps1`
   - Проверяет импорты Backend и линтер Frontend перед каждым коммитом

3. **`temp/templates/test_hypothesis_template.py`** - Шаблон для тестирования гипотез
   - Скопируйте и адаптируйте под свою задачу

4. **`temp/templates/troubleshooting_template.md`** - Шаблон для документирования ошибок
   - Используйте при добавлении новых ошибок в TROUBLESHOOTING.md

#### Создание тестовых скриптов

Создавайте скрипты в `temp/` для проверки гипотез (используйте шаблон):

```python
# temp/test_hypothesis.py
"""Тестирование гипотезы о работе функциональности."""
import requests

BASE_URL = "http://127.0.0.1:8000"

def test_hypothesis():
    # Тест функциональности
    response = requests.get(f"{BASE_URL}/api/endpoint")
    assert response.status_code == 200
    print("✅ Гипотеза подтверждена")

if __name__ == "__main__":
    test_hypothesis()
```

#### Интеграция проверок в workflow

1. **Перед коммитом:**
   - Запустить скрипты проверки
   - Проверить линтер
   - Проверить сборку

2. **После изменений:**
   - Запустить тесты (если есть)
   - Проверить через фронтенд
   - Проверить логи на ошибки

### Pre-commit hooks

Рекомендуется добавить pre-commit hook для автоматических проверок:

```bash
# .git/hooks/pre-commit
#!/bin/bash
# Проверка импортов
python temp/backend/check_imports.py
if [ $? -ne 0 ]; then
    echo "Ошибки импортов! Коммит отклонен."
    exit 1
fi

# Проверка линтера
cd frontend/moderator-dashboard-ui
npm run lint
if [ $? -ne 0 ]; then
    echo "Ошибки линтера! Коммит отклонен."
    exit 1
fi
```

## 3. Улучшение диагностики

### Использование логов для диагностики

#### Структурирование логов

Добавляйте контекстную информацию в логи:

```python
logger.info(f"Adding domain to blacklist: {domain} (normalized: {normalized_domain})")
logger.debug(f"Blacklist entries before: {len(blacklist_before)}, after: {len(blacklist_after)}")
```

#### Проверка логов при диагностике

```powershell
# Проверка последних ошибок
Get-Content "logs\Backend-*.log" -Tail 50 | Select-String -Pattern "ERROR|Exception|Traceback"

# Проверка конкретной функциональности
Get-Content "logs\Backend-*.log" | Select-String -Pattern "blacklist|filtering"
```

### Структурирование ошибок

При документировании ошибок в `docs/TROUBLESHOOTING.md` используйте структуру:

```markdown
## Ошибка N: [Название]

### Описание проблемы
- Что происходит
- Какие ошибки видны
- Где возникает

### Причина
- Почему это происходит
- Что вызывает проблему

### Решение
- Пошаговое решение
- Код изменений
- Команды для применения

### Проверка
- Команды для проверки
- Ожидаемый результат

### Измененные файлы
- Список файлов с изменениями

### Дата решения
YYYY-MM-DD
```

### Создание тестовых сценариев

Создавайте тестовые сценарии для проверки функциональности:

```python
# temp/test_scenario.py
"""Тестовый сценарий: добавление домена в blacklist."""
import requests
import time

def test_add_to_blacklist_scenario():
    """Полный сценарий добавления домена в blacklist."""
    # 1. Получить начальное состояние
    # 2. Добавить домен
    # 3. Проверить, что домен добавлен
    # 4. Проверить фильтрацию
    # 5. Убедиться, что домен исчез из результатов
    pass
```

## 4. Документирование решений

### Шаблоны для документирования исправлений

#### Шаблон для TROUBLESHOOTING.md

```markdown
## Ошибка N: [Краткое название]

### Описание проблемы
[Что происходит, какие ошибки видны, где возникает]

### Причина
[Почему это происходит, что вызывает проблему]

### Решение
[Пошаговое решение с кодом и командами]

### Проверка
[Команды для проверки и ожидаемый результат]

### Измененные файлы
- `path/to/file1.py` - описание изменений
- `path/to/file2.tsx` - описание изменений

### Дата решения
YYYY-MM-DD
```

### Правила обновления TROUBLESHOOTING.md

1. **Каждая ошибка ДОЛЖНА быть задокументирована**
2. **Решения НЕ ДОЛЖНЫ быть удалены** (даже если кажутся устаревшими)
3. **Перед решением новой ошибки** - проверь существующие решения
4. **При изменении кода** - проверь, не ломает ли это существующие решения

### Примеры хорошей документации

**Хороший пример:**
```markdown
## Ошибка: Домен не исчезает после добавления в blacklist

### Описание проблемы
После добавления домена в blacklist через фронтенд, домен продолжает отображаться в результатах парсинга.

### Причина
1. `log_audit` вызывался до `commit()`, что приводило к откату транзакции при ошибке
2. Нормализация домена не совпадала между frontend и backend

### Решение
1. Изменить порядок операций в `backend/app/transport/routers/blacklist.py` - сначала commit, потом audit log
2. Добавить нормализацию root domain в `backend/app/transport/schemas/blacklist.py`
3. Нормализовать домен на frontend перед отправкой

### Проверка
```powershell
# Проверить через API
python temp/test_blacklist_api.py

# Проверить через фронтенд
# Открыть страницу результатов парсинга
# Добавить домен в blacklist
# Убедиться, что домен исчез из списка
```

### Измененные файлы
- `backend/app/transport/routers/blacklist.py` - изменен порядок операций
- `backend/app/transport/schemas/blacklist.py` - добавлена нормализация
- `frontend/moderator-dashboard-ui/app/parsing-runs/[runId]/page.tsx` - нормализация домена

### Дата решения
2025-12-29
```

## 5. Оптимизация процесса разработки

### Разбиение задач на маленькие шаги

**Правило:** Один шаг = одно изменение + проверка

**Пример:**
1. Изменить логику фильтрации → проверить через API
2. Обновить frontend → проверить через фронтенд
3. Добавить нормализацию → проверить через фронтенд

### Проверка после каждого шага

После каждого изменения:
1. Запустить проверки (линтер, сборка)
2. Проверить через API (если применимо)
3. Проверить через фронтенд (если применимо)
4. Только после подтверждения - переходить к следующему шагу

### Использование версионирования для экспериментов

Если решение не очевидно:
1. Создать копию в `temp/` или `experiments/`
2. Протестировать экспериментальную версию
3. Только после подтверждения - перенести в основной код

**Пример:**
```
temp/backend/experiments/new_parsing_flow.py
temp/frontend/experiments/new_supplier_detail.tsx
```

## 6. Рекомендации по приоритетам

### Высокий приоритет (сделать в первую очередь)

1. **Проверка гипотез через фронтенд** - это критически важно для качества
2. **Документирование ошибок** - помогает избежать повторения проблем
3. **Проверка после каждого шага** - предотвращает накопление ошибок

### Средний приоритет

1. **Автоматизация проверок** - экономит время в долгосрочной перспективе
2. **Улучшение диагностики** - ускоряет решение проблем
3. **Создание тестовых сценариев** - помогает проверять функциональность

### Низкий приоритет (можно делать постепенно)

1. **Pre-commit hooks** - улучшает процесс, но не критично
2. **Версионирование экспериментов** - полезно для сложных задач

## 7. Чеклист перед завершением задачи

Перед тем как заявить, что задача завершена:

- [ ] Все изменения задокументированы
- [ ] Проверены импорты (для Backend)
- [ ] Проверена сборка (для Frontend)
- [ ] Проверено через API (если применимо)
- [ ] **Проверено через реальный фронтенд** (если применимо)
- [ ] Проверены логи на ошибки
- [ ] Обновлена документация (TROUBLESHOOTING.md, если новая ошибка)
- [ ] Даны рекомендации для повышения эффективности

## 8. Примеры успешного применения

### Пример 1: Исправление blacklist

**Проблема:** Домен не исчезал после добавления в blacklist

**Подход:**
1. Сформулировали гипотезу: "Проблема в порядке операций commit/audit log"
2. Проверили через API - домен добавлялся, но не сохранялся
3. Проверили логи - увидели, что транзакция откатывается
4. Исправили порядок операций
5. **Проверили через реальный фронтенд** - домен исчезал корректно

**Результат:** Проблема решена за один подход, потому что проверили через фронтенд

### Пример 2: Исправление отображения источников

**Проблема:** Источники отображались неправильно

**Подход:**
1. Сформулировали гипотезу: "Нужно собирать источники на уровне домена"
2. Реализовали функцию `collectDomainSources()`
3. Обновили отображение
4. **Проверили через реальный фронтенд** - источники отображались корректно

**Результат:** Решение работало сразу, потому что проверили через фронтенд

## 9. Заключение

Главное правило: **Всегда проверяй гипотезы через реальный фронтенд**. Это экономит время и предотвращает ошибки.

Одна команда через фронтенд может разобрать проблему быстрее, чем множество предположений.

