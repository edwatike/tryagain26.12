-- –®–ê–ë–õ–û–ù: –ú–∏–≥—Ä–∞—Ü–∏—è —Å –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ–º —Ç–∞–±–ª–∏—Ü—ã –∏ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
-- –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —ç—Ç–æ—Ç —à–∞–±–ª–æ–Ω –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –º–∏–≥—Ä–∞—Ü–∏–π, –∫–æ—Ç–æ—Ä—ã–µ –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤—ã–≤–∞—é—Ç —Ç–∞–±–ª–∏—Ü—ã —Å SERIAL –ø–æ–ª—è–º–∏
-- –î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è: 2025-12-28
-- –û–±–Ω–æ–≤–ª–µ–Ω–æ: 2025-12-28

-- ============================================
-- ‚ö†Ô∏è –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û: –ü—Ä–∏ –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏–∏ —Ç–∞–±–ª–∏—Ü —Å SERIAL –ø–æ–ª—è–º–∏ –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û:
-- 1. –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å (–®–ê–ì 5)
-- 2. –í—ã–¥–∞—Ç—å –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ –Ω–∞ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å (–®–ê–ì 6)
-- ============================================
--
-- üìö –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è:
-- - docs/TROUBLESHOOTING.md - –ë–∏–±–ª–∏—è –æ—à–∏–±–æ–∫ –∏ —Ä–µ—à–µ–Ω–∏–π
-- - docs/MIGRATION_CHECKLIST.md - –ß–µ–∫–ª–∏—Å—Ç –¥–ª—è –º–∏–≥—Ä–∞—Ü–∏–π
-- - docs/FAQ_SEQUENCES.md - FAQ –ø–æ —Ä–∞–±–æ—Ç–µ —Å –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—è–º–∏
--
-- ‚úÖ –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–´–ï –ü–†–û–í–ï–†–ö–ò:
-- 1. –ü–µ—Ä–µ–¥ –∫–æ–º–º–∏—Ç–æ–º: .\scripts\validate-migration.ps1 -MigrationFile "–ø—É—Ç—å/–∫/–º–∏–≥—Ä–∞—Ü–∏–∏.sql"
-- 2. –ü–æ—Å–ª–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è: .\scripts\check-sequences-after-migration.ps1 -TableName "table_name"
-- 3. Pre-commit hook –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –º–∏–≥—Ä–∞—Ü–∏–∏ –ø–µ—Ä–µ–¥ –∫–æ–º–º–∏—Ç–æ–º
-- ============================================

-- –®–ê–ì 1: –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é —Ç–∞–±–ª–∏—Ü—É
CREATE TABLE new_table_name (
    id SERIAL PRIMARY KEY,
    -- –¥—Ä—É–≥–∏–µ –ø–æ–ª—è
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- –®–ê–ì 2: –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
INSERT INTO new_table_name SELECT * FROM old_table_name;

-- –®–ê–ì 3: –£–¥–∞–ª–∏—Ç—å —Å—Ç–∞—Ä—É—é —Ç–∞–±–ª–∏—Ü—É
DROP TABLE old_table_name;

-- –®–ê–ì 4: –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å –Ω–æ–≤—É—é —Ç–∞–±–ª–∏—Ü—É
ALTER TABLE new_table_name RENAME TO table_name;

-- –®–ê–ì 5: –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û - –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å
-- PostgreSQL –º–æ–∂–µ—Ç —Å–æ–∑–¥–∞—Ç—å –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Å —Ä–∞–∑–Ω—ã–º–∏ –∏–º–µ–Ω–∞–º–∏:
-- - new_table_name_id_seq (—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –∏–º—è)
-- - new_table_name_id_seq1 (–µ—Å–ª–∏ –∏–º—è —É–∂–µ –∑–∞–Ω—è—Ç–æ)
DO $$
BEGIN
    -- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤—Å–µ –≤–æ–∑–º–æ–∂–Ω—ã–µ –∏–º–µ–Ω–∞ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
    IF EXISTS (SELECT 1 FROM pg_sequences WHERE sequencename = 'new_table_name_id_seq') THEN
        ALTER SEQUENCE new_table_name_id_seq RENAME TO table_name_id_seq;
        RAISE NOTICE '–ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∞ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å: new_table_name_id_seq -> table_name_id_seq';
    ELSIF EXISTS (SELECT 1 FROM pg_sequences WHERE sequencename = 'new_table_name_id_seq1') THEN
        ALTER SEQUENCE new_table_name_id_seq1 RENAME TO table_name_id_seq;
        RAISE NOTICE '–ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∞ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å: new_table_name_id_seq1 -> table_name_id_seq';
    END IF;
END $$;

-- –®–ê–ì 6: –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û - –í—ã–¥–∞—Ç—å –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞
-- –≠—Ç–æ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω–æ –¥–ª—è —Ä–∞–±–æ—Ç—ã –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è!
GRANT ALL PRIVILEGES ON SEQUENCE table_name_id_seq TO postgres;
GRANT ALL PRIVILEGES ON SEQUENCE table_name_id_seq TO PUBLIC;
ALTER SEQUENCE table_name_id_seq OWNER TO postgres;

-- –®–ê–ì 7: –ü—Ä–æ–≤–µ—Ä–∫–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏)
-- –†–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π—Ç–µ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ—Å–ª–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –º–∏–≥—Ä–∞—Ü–∏–∏:
-- SELECT sequence_name FROM information_schema.sequences WHERE sequence_name LIKE '%table_name%';
-- \dp table_name_id_seq

-- ============================================
-- ‚úÖ –ü–û–°–õ–ï –ü–†–ò–ú–ï–ù–ï–ù–ò–Ø –ú–ò–ì–†–ê–¶–ò–ò –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û:
-- 1. –ó–∞–ø—É—Å—Ç–∏—Ç—å: .\scripts\check-sequences-after-migration.ps1 -TableName "table_name"
-- 2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
-- 3. –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–π –ø–∞—Ä—Å–∏–Ω–≥ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
-- 4. –ï—Å–ª–∏ –µ—Å—Ç—å –æ—à–∏–±–∫–∏ - –ø—Ä–æ–≤–µ—Ä–∏—Ç—å docs/TROUBLESHOOTING.md
-- ============================================

